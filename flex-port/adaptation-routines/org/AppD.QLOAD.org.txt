* QLOAD - QUICK LOADER
*
* COPYRIGHT (C) 1980 BY
* TECHNICAL SYSTEMS CONSULTANTS, INC.
* 111 PROVIDENCE RD. CHAPEL HILL, NC 27514
* LOADS FLEX FROM DISK ASSUMING THAT THE DISK I/O
* ROUTINES ARE ALREADY IN MEMORY. ASSUMES FLEX
* BEGINS ON TRACK #1 SECTOR #1. RETURNS TO
* MONITOR ON COMPLETION. BEGIN EXECUTION BY
* JUMPING TO LOCATION $C100
*
* EQUATES
C07F STACK EQU $C07F
D3F3 MONITR EQU $D3F3
DE00 READ EQU $DE00
DE09 RESTORE EQU $DE09
DE0C DRIVE EQU $DE0C
C300 SCTBUF EQU $C300 DATA SECTOR BUFFER
* START OF UTILITY
C100 ORG $C100
C100 20 08 QLOAD BRA LOAD0
C102 00 00 00 FCB 0,0,0
C105 01 TRK FCB 1 FILE START TRACK
C106 01 SCT FCB 1 FILE START SECTOR
C107 00 DNS FCB 0 DENSITY FLAG
C108 0000 LADR FDB 0 LOAD ADDRESS
C10A 10CE C07F LOAD0 LDS #STACK SETUP STACK
C10E BE C300 LDX #SCTBUF POINT TO FCB
C111 6F 03 CLR 3,X SET FOR DRIVE 0
C113 BD DE0C JSR DRIVE SELECT DRIVE 0
C116 8E C300 LDX #SCTBUF
C119 BD DE09 JSR RESTORE NOW RESTORE TO TRACK 0
C11C FC C105 LDD TRK SETUP STARTING TRK & SCT
C11F FD C300 STD SCTBUF
C122 108E C400 LDY #SCTBUF+256
* PERFORM ACTUAL FILE LOAD
C126 BD 2F LOAD1 BSR GETCH GET A CHARACTER
C128 81 02 CMPA #$02 DATA RECORD HEADER?
Page 55 - Appendix D
6809 FLEX Adaptation Guide QLOAD UTILITY
C12A 27 0A BEQ LOAD2 SKIP IF SO
C12C 81 16 CMPA #$16 XFR ADDRESS HEADER?
C12E 26 F6 BNE LOAD1 LOOP IF NEITHER
C130 8D 25 BSR GETCH GET TRANSFER ADDRESS
C132 8D 23 BSR GETCH DISCARD IT
C134 20 F0 BRA LOAD1 CONTINUE LOAD
C136 8D 1F LOAD2 BSR GETCH GET LOAD ADDRESS
C138 B7 C108 STA LADR
C13B 8D 1A BSR GETCH
C13D B7 C109 STA LADR+1
C140 8D 15 BSR GETCH GET BYTE COUNT
C142 1F 894D TAB PUT IN B
C145 27 DF BEQ LOAD1 LOOP IF COUNT=0
C147 BE C108 LDX LADR GET LOAD ADDRESS IN X
C14A 34 14 LOAD3 PSHS B,X
C14C 8D 09 BSR GETCH GET A DATA CHARACTER
C14E 35 14 PULS B,X
C150 A7 80 STA 0,X+ PUT CHARACTER
C152 5A DECB END OF DATA IN RECORD?
C153 26 F5 BNE LOAD3 LOOP IF NOT
C155 20 CF BRA LOAD1 GET ANOTHER RECORD
* GET CHARACTER ROUTINE - READS A SECTOR IF NECESSARY
C157 108C C400 GETCH CMPY #SCTBUF+256 OUT OF DATA?
C15B 26 10 BNE GETCH4 GO READ CHARACTER IF NOT
C15D 8E C300 GETCH2 LDX #SCTBUF POINT TO BUFFER
C160 EC 84 LDD 0,X GET FORWARD LINK
C162 27 0C BEQ GO IF ZERO, FILE IS LOADED
C164 BD DE00 JSR READ READ NEXT SECTOR
C167 26 97 BNE QLOAD START OVER IF ERROR
C169 108E C304 LDY #SCTBUF+4 POINT PAST LINK
C16D A6 A0 GETCH4 LDA 0,Y+ ELSE, GET A CHARACTER
C16F 39 RTS
* FILE IS LOADED, RETURN TO MONITOR
C170 6E 9F D3F3 GO JMPI [MONITR] JUMP TO MONITOR
END