* LOADER - FLEX LOADER ROUTINE
*
* COPYRIGHT (C) 1980 BY
* TECHNICAL SYSTEMS CONSULTANTS INC.
* 111 PROVIDENCE RD, CHAPEL HILL, NC 27514
*
* LOADS FLEX FROM DISK. ASSUMES DRIVE IS ALREADY
* SELECTED AND A RESTORE HAS BEEN PERFORMED BY THE
* ROM BOOT AND THAT STARTING TRACK AND SECTOR OF
* FLEX ARE AT $C105 AND $C106. BEGIN EXECUTION
* BY JUMPING TO LOCATION $C100. JUMPS TO FLEX
* STARTUP WHEN COMPLETE.
*
* EQUATES
C07F STACK EQU $C07F
C300 SCTBUF EQU $C300 DATA SECTOR BUFFER
* START OF UTILITY
C100 ORG $C100
C100 20 0A LOAD BRA LOAD0
C102 00 00 00 FCB 0,0,0
C105 00 TRK FCB 0 FILE START TRACK
C106 00 SCT FCB 0 FILE START SECTOR
C107 00 DNS FCB 0 DENSITY FLAG
C108 C100 TADR FDB $c100 TRANSFER ADDRESS
C10A 0000 LADR FDB 0 LOAD ADDRESS
C10C 10CE C07F LOAD0 LDS #STACK SETUP STACK
C110 FC C105 LDD TRK SETUP STARTING TRK & SCT
C113 FD C300 STD SCTBUF
C116 108E C400 LDY #SCTBUF+256
* PERFORM ACTUAL FILE LOAD
C11A 8D 35 LOAD1 BSR GETCH GET A CHARACTER
C11C 81 02 CMPA #$02 DATA RECORD HEADER?
C11E 27 10 BEQ LOAD2 SKIP IF SO
C120 81 16 CMPA #$16 XFR ADDRESS HEADER?
C122 26 F6 BNE LOAD1 LOOP IF NEITHER
C124 8D 2B BSR GETCH GET TRANSFER ADDRESS
C126 B7 C108 STA TADR
C129 8D 26 BSR GETCH
C12B B7 C109 STA TADR+1
C12E 20 EA BRA LOAD1 CONTINUE LOAD
C130 8D 1F LOAD2 BSR GETCH GET LOAD ADDRESS
C132 B7 C10A STA LADR
C135 8D 1A BSR GETCH
C137 B7 C10B STA LADR+1
Page 87 - Appendix G
6809 FLEX Adaptation Guide Sample FLEX Loader
C13A 8D 15 BSR GETCH GET BYTE COUNT
C13C 1F 894D TAB PUT IN B
C13F 27 D9 BEQ LOAD1 LOOP IF COUNT=0
C141 BE C10A LDX LADR GET LOAD ADDRESS
C144 34 14 LOAD3 PSHS B,X
C146 8D 09 BSR GETCH GET A DATA CHARACTER
C148 35 14 PULS B,X
C14A A7 80 STA 0,X+ PUT CHARACTER
C14C 5A DECB END OF DATA IN RECORD?
C14D 26 F5 BNE LOAD3 LOOP IF NOT
C14F 20 C9 BRA LOAD1 GET ANOTHER RECORD
* GET CHARACTER ROUTINE - READS A SECTOR IF NECESSARY
C151 108C C400 GETCH CMPY #SCTBUF+256 OUT OF DATA?
C155 26 0F BNE GETCH4 GO READ CHARACTER IF NOT
C157 8E C300 GETCH2 LDX #SCTBUF POINT TO BUFFER
C15A EC 84 LDD 0,X GET FORWARD LINK
C15C 27 0B BEQ GO IF ZERO, FILE IS LOADED
C15E 8D 0D BSR READ READ NEXT SECTOR
C160 26 9E BNE LOAD START OVER IF ERROR
C162 108E C304 LDY #SCTBUF+4 POINT PAST LINK
C166 A6 A0 GETCH4 LDA 0,Y+ ELSE, GET A CHARACTER
C168 39 RTS
* FILE IS LOADED, JUMP TO IT
C169 6E 9F C108 GO JMP [TADR] JUMP TO TRANSFER ADDRESS
* READ SINGLE SECTOR
*
* THIS ROUTINE MUST READ THE SECTOR WHOSE TRACK
* AND SECTOR ADDRESS ARE IN A ANB B ON ENTRY.
* THE DATA FROM THE SECTOR IS TO BE PLACED AT
* THE ADDRESS CONTAINED IN X ON ENTRY.
* IF ERRORS, A NOT-EQUAL CONDITION SHOULD BE
* RETURNED. THIS ROUTINE WILL HAVE TO DO SEEKS.
* A,B,X, AND U MAY BE DESTROYED BY THIS ROUTINE,
* BUT Y MUST BE PRESERVED.
* WESTERN DIGITAL EQUATES
E018 COMREG EQU $E018 COMMAND REGISTER
E019 TRKREG EQU $E019 TRACK REGISTER
E01A SECREG EQU $E01A SECTOR REGISTER
E01B DATREG EQU $E01B DATA REGISTER
0002 DRQ EQU 2 DRQ BIT MASK
0001 BUSY EQU 1 BUSY MASK
001C RDMSK EQU $1C READ ERROR MASK
008C RDCMND EQU $8C READ COMMAND
001B SKCMND EQU $1B SEEK COMMAND
* READ ONE SECTOR
Page 88 - Appendix G
Sample FLEX Loader 6809 FLEX Adaptation Guide
C16D 8D 2F READ BSR XSEEK SEEK TO TRACK
C16F 86 8C LDA #RDCMND SETUP READ SECTOR COMMAND
C171 B7 E018 STA COMREG ISSUE READ COMMAND
C174 BD 3E BSR DEL28 DELAY
C176 5F CLRB GET SECTOR LENGTH (=256)
C177 BE C300 LDX #SCTBUF POINT TO SECTOR BUFFER
C17A B6 E018 READ3 LDA COMREG GET WD STATUS
C17D 85 02 BITA #DRQ CHECK FOR DATA
C17F 26 08 BNE READ5 BRANCH IF DATA PRESENT
C181 85 01 BITA #BUSY CHECK IF BUSY
C183 26 F5 BNE READ3 LOOP IF SO
C185 1F 89 TFR A,B SAVE ERROR CONDITION
C187 20 0A BRA READ6
C189 B6 E01B READ5 LDA DATREG GET DATA BYTE
C18C A7 80 STA 0,X+ PUT IN MEMORY
C18E 5A DECB DEC THE COUNTER
C18F 26 E9 BNE READ3 LOOP TIL DONE
C191 8D 03 BSR XWAIT WAIT TIL WD IS FINISHED
C193 C5 1C READ6 BITB #RDMSK MASK ERRORS
C195 39 RTS RETURN
* WAIT FOR 1771 TO FINISH COMMAND
C196 F6 E018 XWAIT LDB COMREG GET WD STATUS
C199 C5 01 BITB #BUSY CHECK IF BUSY
C19B 26 F9 BNE XWAIT LOOP TIL NOT BUSY
C19D 39 RTS RETURN
* SEEK THE SPECIFIED TRACK
C19E F7 E01A XSEEK STB SECREG SET SECTOR
C1A1 Bl E019 CMPA TRKREG DIF THAN LAST?
C1A4 27 0E BEQ DEL28 EXIT IF NOT
C1A6 B7 E01B STA DATREG SET NEW WD TRACK
C1A9 8D 09 BSR DEL28 GO DELAY
C1AB 86 1B LDA #SKCMN SETUP SEEK COMMAND
C1AD B7 E018 STA COMREG ISSUE SEEK COMMAND
C1B0 BD 02 BSR DEL28 GO DELAY
C1B2 BD E2 BSR XWAIT WAIT TIL DONE
* DELAY
C1B4 BD C1B7 DEL28 JSR DEL14
C1B7 BD C1BA DEL14 JSR DEL
C1BA 39 DEL RTS
END